# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Security

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # Detect if security-relevant files changed
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      cargo: ${{ steps.filter.outputs.cargo }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for dependency changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cargo:
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '**/Cargo.toml'
              - '.github/workflows/security.yml'

  dependency-review:
    name: Dependency Review
    needs: [detect-changes]
    runs-on: ubuntu-latest
    # Only run if Cargo files changed AND not triggered by dependabot
    if: needs.detect-changes.outputs.cargo == 'true' && github.actor != 'dependabot[bot]'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  # Security scan summary - aggregates all security job results
  # This job ALWAYS runs to satisfy required status checks
  security-summary:
    name: Security Summary
    needs: [detect-changes, dependency-review]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Check security scan results
        env:
          CARGO_CHANGES: ${{ needs.detect-changes.outputs.cargo }}
          DEPENDENCY_REVIEW_RESULT: ${{ needs.dependency-review.result }}
        run: |
          echo "## Security Scan Results"
          echo ""

          # If no security-relevant files changed, report success immediately
          if [[ "$CARGO_CHANGES" != "true" ]]; then
            echo "No Cargo dependency changes detected - security scan not required."
            echo ""
            echo "Security checks passed (no relevant changes)"
            exit 0
          fi

          echo "| Scanner | Status |"
          echo "|---------|--------|"
          echo "| Dependency Review | $DEPENDENCY_REVIEW_RESULT |"
          echo ""

          # Fail if any security job failed
          if [[ "$DEPENDENCY_REVIEW_RESULT" != "success" && "$DEPENDENCY_REVIEW_RESULT" != "skipped" ]]; then
            echo "Security checks failed"
            exit 1
          fi

          echo "All security checks passed!"
