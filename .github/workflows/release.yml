# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json

name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
      dry_run:
        description: "Dry run (don't actually publish)"
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Validate the release
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get version from tag
        id: get_version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          REF_NAME: ${{ github.ref_name }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "version=$REF_NAME" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable

      - name: Install protobuf compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq protobuf-compiler

      - name: Verify Cargo.toml version matches tag
        env:
          TAG_VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          CARGO_VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "inferadb-ledger-sdk") | .version')
          TAG_VERSION_CLEAN="${TAG_VERSION#v}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION_CLEAN" ]; then
            echo "Version mismatch: Cargo.toml has $CARGO_VERSION but tag is $TAG_VERSION_CLEAN"
            exit 1
          fi
          echo "Version validated: $CARGO_VERSION"

      - name: Run tests
        run: cargo test --workspace --lib

      - name: Check documentation builds
        env:
          RUSTDOCFLAGS: -D warnings
        run: cargo doc --workspace --no-deps

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create Release
        uses: step-security/action-gh-release@5f6a6ab53a5a2c000ff3a16fad038291e5b97ce7 # v2.4.2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: ${{ needs.validate.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true

  # Publish to crates.io
  publish:
    name: Publish to crates.io
    needs: [validate, create-release]
    runs-on: ubuntu-latest
    environment: release
    if: github.event.inputs.dry_run != 'true'
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@56f84321dbccf38fb67ce29ab63e4754056677e0 # stable

      - name: Install protobuf compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq protobuf-compiler

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2

      # Use OIDC-based trusted publishing
      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      # Publish crates in dependency order with delays for crates.io indexing
      - name: Publish inferadb-ledger-types
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish -p inferadb-ledger-types --token "$CARGO_REGISTRY_TOKEN" --allow-dirty || echo "inferadb-ledger-types may already be published"
          echo "Waiting for crates.io to index..."
          sleep 45

      - name: Publish inferadb-ledger-store
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish -p inferadb-ledger-store --token "$CARGO_REGISTRY_TOKEN" --allow-dirty || echo "inferadb-ledger-store may already be published"
          echo "Waiting for crates.io to index..."
          sleep 45

      - name: Publish inferadb-ledger-state
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish -p inferadb-ledger-state --token "$CARGO_REGISTRY_TOKEN" --allow-dirty || echo "inferadb-ledger-state may already be published"
          echo "Waiting for crates.io to index..."
          sleep 45

      - name: Publish inferadb-ledger-raft
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish -p inferadb-ledger-raft --token "$CARGO_REGISTRY_TOKEN" --allow-dirty || echo "inferadb-ledger-raft may already be published"
          echo "Waiting for crates.io to index..."
          sleep 45

      - name: Publish inferadb-ledger-sdk
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          cargo publish -p inferadb-ledger-sdk --token "$CARGO_REGISTRY_TOKEN" --allow-dirty

  # Build and publish documentation
  docs:
    name: Build Documentation
    needs: [validate, publish]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Rust nightly toolchain
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly

      - name: Install protobuf compiler
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq protobuf-compiler

      - name: Cache Rust dependencies
        uses: step-security/rust-cache@f8fba7098297c8c53a7c9a30575ec2ad4ad85056 # v2.8.2

      - name: Build documentation
        env:
          RUSTDOCFLAGS: --cfg docsrs
        run: cargo +nightly doc --workspace --no-deps

      - name: Add index redirect
        run: |
          echo '<meta http-equiv="refresh" content="0; url=inferadb_ledger_sdk">' > target/doc/index.html

      - name: Upload documentation artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: documentation
          path: target/doc
          retention-days: 30
