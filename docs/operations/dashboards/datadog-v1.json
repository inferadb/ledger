{
  "schema_version": 1,
  "min_ledger_version": "0.5.0",
  "title": "InferaDB Ledger Logging",
  "description": "Comprehensive observability for InferaDB Ledger gRPC requests using canonical log lines",
  "widgets": [
    {
      "id": 1,
      "definition": {
        "title": "Request Rate by Service/Method",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [{ "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service $method" },
                "indexes": ["*"],
                "group_by": [
                  { "facet": "@service", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } },
                  { "facet": "@method", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }
                ],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic", "line_type": "solid", "line_width": "normal" },
            "display_type": "line"
          }
        ]
      },
      "layout": { "x": 0, "y": 0, "width": 6, "height": 3 }
    },
    {
      "id": 2,
      "definition": {
        "title": "Error Rate by Error Code",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [{ "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @outcome:error $service" },
                "indexes": ["*"],
                "group_by": [
                  { "facet": "@error_code", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }
                ],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "warm", "line_type": "solid", "line_width": "normal" },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 6, "y": 0, "width": 6, "height": 3 }
    },
    {
      "id": 3,
      "definition": {
        "title": "Latency Percentiles by Method",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "alias": "p50", "formula": "query1" },
              { "alias": "p95", "formula": "query2" },
              { "alias": "p99", "formula": "query3" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service $method" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@method", "limit": 10, "sort": { "aggregation": "pc50", "order": "desc", "metric": "@duration_ms" } }],
                "compute": { "aggregation": "pc50", "metric": "@duration_ms" }
              },
              {
                "name": "query2",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service $method" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@method", "limit": 10, "sort": { "aggregation": "pc95", "order": "desc", "metric": "@duration_ms" } }],
                "compute": { "aggregation": "pc95", "metric": "@duration_ms" }
              },
              {
                "name": "query3",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service $method" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@method", "limit": 10, "sort": { "aggregation": "pc99", "order": "desc", "metric": "@duration_ms" } }],
                "compute": { "aggregation": "pc99", "metric": "@duration_ms" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic", "line_type": "solid", "line_width": "normal" },
            "display_type": "line"
          }
        ],
        "yaxis": { "label": "Duration (ms)", "scale": "linear", "include_zero": true }
      },
      "layout": { "x": 0, "y": 3, "width": 6, "height": 3 }
    },
    {
      "id": 4,
      "definition": {
        "title": "Latency Heatmap",
        "title_size": "16",
        "title_align": "left",
        "type": "heatmap",
        "requests": [
          {
            "formulas": [{ "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service $method" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "count", "metric": "@duration_ms" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic" }
          }
        ],
        "yaxis": { "include_zero": true }
      },
      "layout": { "x": 6, "y": 3, "width": 6, "height": 3 }
    },
    {
      "id": 5,
      "definition": {
        "title": "Top 10 Clients by Request Count",
        "title_size": "16",
        "title_align": "left",
        "type": "toplist",
        "requests": [
          {
            "formulas": [{ "formula": "query1", "limit": { "count": 10, "order": "desc" } }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@client_id", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "scalar"
          }
        ]
      },
      "layout": { "x": 0, "y": 6, "width": 6, "height": 3 }
    },
    {
      "id": 6,
      "definition": {
        "title": "Top 10 Organizations by Error Count",
        "title_size": "16",
        "title_align": "left",
        "type": "toplist",
        "requests": [
          {
            "formulas": [{ "formula": "query1", "limit": { "count": 10, "order": "desc" } }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @outcome:error" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@organization_slug", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "scalar"
          }
        ],
        "style": { "display": { "type": "stacked", "legend": "inline" }, "palette": "warm" }
      },
      "layout": { "x": 6, "y": 6, "width": 6, "height": 3 }
    },
    {
      "id": 7,
      "definition": {
        "title": "Request Outcomes Distribution",
        "title_size": "16",
        "title_align": "left",
        "type": "sunburst",
        "requests": [
          {
            "formulas": [{ "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger $service" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@outcome", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "scalar"
          }
        ]
      },
      "layout": { "x": 0, "y": 9, "width": 4, "height": 3 }
    },
    {
      "id": 8,
      "definition": {
        "title": "Batch Coalescing Efficiency",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [{ "alias": "Avg Batch Size", "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @batch_coalesced:true" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "avg", "metric": "@batch_size" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic", "line_type": "solid", "line_width": "normal" },
            "display_type": "line"
          }
        ]
      },
      "layout": { "x": 4, "y": 9, "width": 4, "height": 3 }
    },
    {
      "id": 9,
      "definition": {
        "title": "Idempotency Cache Hit Rate",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "alias": "Hit Rate", "formula": "query1 / query2" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @idempotency_hit:true" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "count" }
              },
              {
                "name": "query2",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @method:write" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic", "line_type": "solid", "line_width": "normal" },
            "display_type": "line"
          }
        ],
        "yaxis": { "label": "Hit Rate", "scale": "linear", "include_zero": true, "max": "1" }
      },
      "layout": { "x": 8, "y": 9, "width": 4, "height": 3 }
    },
    {
      "id": 10,
      "definition": {
        "title": "Raft vs Storage Latency Breakdown",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [
              { "alias": "Raft Latency", "formula": "query1" },
              { "alias": "Storage Latency", "formula": "query2" }
            ],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @method:write" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "avg", "metric": "@raft_latency_ms" }
              },
              {
                "name": "query2",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger" },
                "indexes": ["*"],
                "group_by": [],
                "compute": { "aggregation": "avg", "metric": "@storage_latency_ms" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "dog_classic", "line_type": "solid", "line_width": "normal" },
            "display_type": "area"
          }
        ],
        "yaxis": { "label": "Latency (ms)", "scale": "linear", "include_zero": true }
      },
      "layout": { "x": 0, "y": 12, "width": 6, "height": 3 }
    },
    {
      "id": 11,
      "definition": {
        "title": "VIP Organization Traffic",
        "title_size": "16",
        "title_align": "left",
        "show_legend": true,
        "legend_layout": "auto",
        "legend_columns": ["avg", "max", "value"],
        "type": "timeseries",
        "requests": [
          {
            "formulas": [{ "formula": "query1" }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @is_vip:true" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@method", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "timeseries",
            "style": { "palette": "cool", "line_type": "solid", "line_width": "normal" },
            "display_type": "bars"
          }
        ]
      },
      "layout": { "x": 6, "y": 12, "width": 6, "height": 3 }
    },
    {
      "id": 12,
      "definition": {
        "title": "Rate Limited Requests by Client",
        "title_size": "16",
        "title_align": "left",
        "type": "toplist",
        "requests": [
          {
            "formulas": [{ "formula": "query1", "limit": { "count": 10, "order": "desc" } }],
            "queries": [
              {
                "name": "query1",
                "data_source": "logs",
                "search": { "query": "service:inferadb-ledger @outcome:rate_limited" },
                "indexes": ["*"],
                "group_by": [{ "facet": "@client_id", "limit": 10, "sort": { "aggregation": "count", "order": "desc" } }],
                "compute": { "aggregation": "count" }
              }
            ],
            "response_format": "scalar"
          }
        ],
        "style": { "display": { "type": "stacked", "legend": "inline" }, "palette": "orange" }
      },
      "layout": { "x": 0, "y": 15, "width": 6, "height": 3 }
    },
    {
      "id": 13,
      "definition": {
        "title": "Trace ID Search",
        "title_size": "16",
        "title_align": "left",
        "type": "log_stream",
        "indexes": [],
        "query": "service:inferadb-ledger $trace_id",
        "sort": { "column": "time", "order": "desc" },
        "columns": ["@service", "@method", "@outcome", "@duration_ms", "@trace_id"],
        "show_date_column": true,
        "show_message_column": false,
        "message_display": "inline"
      },
      "layout": { "x": 6, "y": 15, "width": 6, "height": 3 }
    }
  ],
  "template_variables": [
    {
      "name": "service",
      "prefix": "@service",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "method",
      "prefix": "@method",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "organization",
      "prefix": "@organization_slug",
      "available_values": [],
      "default": "*"
    },
    {
      "name": "outcome",
      "prefix": "@outcome",
      "available_values": ["success", "error", "cached", "rate_limited", "precondition_failed"],
      "default": "*"
    },
    {
      "name": "trace_id",
      "prefix": "@trace_id",
      "available_values": [],
      "default": "*"
    }
  ],
  "layout_type": "ordered",
  "notify_list": [],
  "reflow_type": "fixed",
  "tags": ["inferadb", "logging", "observability"]
}
